import StyleDictionary from 'style-dictionary';
import { initializeCustomTransforms } from './transforms.mjs';

// Initialize custom transforms and groups
initializeCustomTransforms();

// Register themed CSS variables format (SD v4 uses `format` function)
StyleDictionary.registerFormat({
  name: 'css/variables-themed',
  format: ({ dictionary, options }) => {
    const theme = options?.theme || 'light';
    const toJsKey = (name) => name.replace(/-([a-z])/g, (_, c) => c.toUpperCase());

    const lines = dictionary.allTokens.map((token) => {
      const base = token.name.startsWith('dyn-') ? token.name : `dyn-${token.name}`;
      return `  --${base}: ${token.value};`;
    }).join('\n');

    const jsMap = dictionary.allTokens.map((token) => {
      const base = token.name.startsWith('dyn-') ? token.name : `dyn-${token.name}`;
      return `  '${toJsKey(base)}': 'var(--${base})',`;
    }).join('\n');

    return `/* DynUI Design Tokens - ${theme} theme */\n/* Auto-generated by Style Dictionary - DO NOT EDIT */\n\n:root,\n[data-theme="${theme}"] {\n${lines}\n}\n\n/* CSS Custom Properties Export for JavaScript */\nexport const ${theme}Tokens = {\n${jsMap}\n};\n`;
  }
});

export default {
  source: ['src/tokens/**/*.json'],
  platforms: {
    css: {
      transformGroup: 'dyn/css',
      buildPath: 'dist/',
      files: [
        { destination: 'tokens.css', format: 'css/variables-themed', options: { theme: 'light' } },
        { destination: 'tokens-dark.css', format: 'css/variables-themed', options: { theme: 'dark' } },
        { destination: 'variables.css', format: 'css/variables' }
      ]
    },
    js: {
      transformGroup: 'js',
      buildPath: 'dist/',
      files: [
        { destination: 'tokens.js', format: 'javascript/es6' }
      ]
    },
    json: {
      transformGroup: 'js',
      buildPath: 'dist/',
      files: [
        { destination: 'tokens.json', format: 'json/flat' },
        { destination: 'tokens-nested.json', format: 'json/nested' }
      ]
    }
  }
};